/*! Copyright (c) 2023 WhatsApp Inc. All Rights Reserved. */
(self.webpackChunkwhatsapp_web_client=self.webpackChunkwhatsapp_web_client||[]).push([[2266],{273925:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JobBuilder=void 0,t.definePersistedJob=function(){return new i([])};var n=r(811158),s=r(632157);class i{constructor(e){this.steps=e}step(e,t){return this._stepWithOptions(e,"function"==typeof t?{code:t}:t)}_stepWithOptions(e,t){const{stopRetryIf:r,requirements:d,code:u}=t;let p=a(d,u,r);if(r){const{timePassedSeconds:e,appCrashed:t,onStopRetry:i}=r,d=a(null,function(e){return(t,r,s)=>Promise.resolve(e(t,r,s)).then((e=>e instanceof n.InterruptJob?e:new n.InterruptJob(e)))}(i),r);null!=e&&(p=o(((t,r,n)=>{let{jobStartTime:i}=n;return(0,s.happenedWithin)(i,e)}),p,d)),t&&(p=o(((e,t,r)=>{let{afterCrash:n}=r;return!n}),p,d))}return new i([...this.steps,{stepName:e,info:p}])}finalStep(e,t){const r=this.step(e,t);return{end:()=>r.steps}}}function o(e,t,r){return(n,s,i)=>e(n,s,i)?t(n,s,i):r(n,s,i)}function a(e,t,r){const n={requirements:e,code:t,stopRetryIf:r};return()=>n}t.JobBuilder=i},193182:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineWebPersistedJob=function(){return(0,n.definePersistedJob)()};var n=r(273925)},322266:(e,t,r)=>{"use strict";var n=r(595318);Object.defineProperty(t,"__esModule",{value:!0}),t.rotateKey=void 0;var s=n(r(348926)),i=r(67201),o=r(504784),a=r(358452),d=r(403206),u=r(492917),p=r(193182),l=r(9210),c=r(431028),y=r(326314),_=r(732974);const f=new a.WapParser("rotateKeyResponseParser",(e=>{e.assertFromServer()})),b=(0,p.defineWebPersistedJob)().step("uploadKeys",(0,s.default)((function*(){const e=yield y.waSignalStore.getRegistrationInfo().then((e=>{if(!e)throw new Error("No registration info is available");return y.waSignalStore.rotateSignedPreKey((0,u.isCryptoLibraryEnabled)()?e.identityKeyPair:(0,d.toSignalCurveKeyPair)(e.identityKeyPair),c.generateSignedKeyPair)}));__LOG__(2)`rotateKey: signedPreKey uploading`;const t=(0,o.wap)("iq",{xmlns:"encrypt",type:"set",to:o.S_WHATSAPP_NET,id:(0,o.generateId)()},(0,o.wap)("rotate",null,(0,_.xmppSignedPreKey)(e))),r=yield(0,i.deprecatedSendIq)(t,f);if(r.success)return{shouldDigestKey:!1};let n=!1;const s=r.errorCode;return 406===s?__LOG__(3)`rotateKey generated bad key`:409===s?(__LOG__(3)`skey does not pass server validation`,n=!0):s>=500?__LOG__(2)`rotateKey server error ${s}, wait a day`:(__LOG__(2)`rotateKey unrecognized error ${s}`,n=!0),{shouldDigestKey:n}}))).finalStep("maybeDigestKey",(e=>{const{shouldDigestKey:t}=e;if(t)return(0,l.digestKey)()})).end();t.rotateKey=b}}]);
//# sourceMappingURL=https://web.whatsapp.com/2266.fbd6bfc838930b80fba5.js.map
