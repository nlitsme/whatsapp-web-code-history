/*! Copyright (c) 2021 WhatsApp Inc. All Rights Reserved. */
(self.webpackChunkbuild=self.webpackChunkbuild||[]).push([[7903],{98532:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.defineWebPersistedJob=function(e){return(0,a.definePersistedJob)(e)};var a=t(75987)},87903:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var a=t(82420),i=t(35773),n=t(446),s=t(7017),o=t(24606),d=t(76295),u=t(8456),y=t(83756),_=t(98532),l=new a.WapParser("rotateKeyResponseParser",(e=>{e.assertFromServer()})),g=(0,_.defineWebPersistedJob)("rotateKey").step("uploadKeys",(()=>o.waSignalStore.getRegistrationInfo().then((e=>{if(!e)throw new Error("No registration info is available");return o.waSignalStore.rotateSignedPreKey((0,n.toSignalCurveKeyPair)(e.identityKeyPair),d.generateSignedKeyPair)})).then((e=>{__LOG__(2)`rotateKey: signedPreKey uploading`;var r=(0,i.wap)("iq",{xmlns:"encrypt",type:"set",to:i.S_WHATSAPP_NET,id:(0,i.generateId)()},(0,i.wap)("rotate",null,(0,u.xmppSignedPreKey)(e)));return(0,s.sendIq)(r,l).then((e=>{if(e.success)return{shouldDigestKey:!1};var r=!1,t=e.errorCode;return 406===t?__LOG__(3)`rotateKey generated bad key`:409===t?(__LOG__(3)`skey does not pass server validation`,r=!0):t>=500?__LOG__(2)`rotateKey server error ${t}, wait a day`:(__LOG__(2)`rotateKey unrecognized error ${t}`,r=!0),{shouldDigestKey:r}}))})))).finalStep("maybeDigestKey",(e=>{var{shouldDigestKey:r}=e;if(r)return(0,y.digestKey)()})).end();r.default=g}}]);