/*! Copyright (c) 2021 WhatsApp Inc. All Rights Reserved. */
(self.webpackChunkwhatsapp_web_client=self.webpackChunkwhatsapp_web_client||[]).push([[67],{15115:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.definePersistedJob=function(){return new i([])},t.JobBuilder=void 0;var n=r(57148),s=r(55329);class i{constructor(e){this.steps=e}step(e,t){return this._stepWithOptions(e,"function"==typeof t?{code:t}:t)}_stepWithOptions(e,t){const{stopRetryIf:r,requirements:d,code:u}=t;let p=a(d,u,r);if(r){const{timePassedSeconds:e,appCrashed:t,onStopRetry:i}=r,d=a(null,function(e){return(t,r,n)=>Promise.resolve(e(t,r,n)).then((e=>e instanceof s.InterruptJob?e:new s.InterruptJob(e)))}(i),r);null!=e&&(p=o(((t,r,{jobStartTime:s})=>(0,n.happenedWithin)(s,e)),p,d)),t&&(p=o(((e,t,{afterCrash:r})=>!r),p,d))}return new i([...this.steps,{stepName:e,info:p}])}finalStep(e,t){const r=this.step(e,t);return{end:()=>r.steps}}}function o(e,t,r){return(n,s,i)=>e(n,s,i)?t(n,s,i):r(n,s,i)}function a(e,t,r){const n={requirements:e,code:t,stopRetryIf:r};return()=>n}t.JobBuilder=i},50113:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineWebPersistedJob=function(){return(0,n.definePersistedJob)()};var n=r(15115)},60067:(e,t,r)=>{"use strict";var n=r(95318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=n(r(48926)),i=r(8701),o=r(43129),a=r(86109),d=r(84922),u=r(93381),p=r(29334),l=r(84105),c=r(44759),_=r(50113);const f=new i.WapParser("rotateKeyResponseParser",(e=>{e.assertFromServer()}));var y=(0,_.defineWebPersistedJob)().step("uploadKeys",(0,s.default)((function*(){const e=yield u.waSignalStore.getRegistrationInfo().then((e=>{if(!e)throw new Error("No registration info is available");return u.waSignalStore.rotateSignedPreKey((0,a.toSignalCurveKeyPair)(e.identityKeyPair),p.generateSignedKeyPair)}));__LOG__(2)`rotateKey: signedPreKey uploading`;const t=(0,o.wap)("iq",{xmlns:"encrypt",type:"set",to:o.S_WHATSAPP_NET,id:(0,o.generateId)()},(0,o.wap)("rotate",null,(0,l.xmppSignedPreKey)(e))),r=yield(0,d.sendIq)(t,f);if(r.success)return{shouldDigestKey:!1};let n=!1;const s=r.errorCode;return 406===s?__LOG__(3)`rotateKey generated bad key`:409===s?(__LOG__(3)`skey does not pass server validation`,n=!0):s>=500?__LOG__(2)`rotateKey server error ${s}, wait a day`:(__LOG__(2)`rotateKey unrecognized error ${s}`,n=!0),{shouldDigestKey:n}}))).finalStep("maybeDigestKey",(e=>{const{shouldDigestKey:t}=e;if(t)return(0,c.digestKey)()})).end();t.default=y}}]);