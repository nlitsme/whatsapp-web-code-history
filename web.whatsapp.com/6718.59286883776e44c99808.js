/*! Copyright (c) 2022 WhatsApp Inc. All Rights Reserved. */
(self.webpackChunkwhatsapp_web_client=self.webpackChunkwhatsapp_web_client||[]).push([[6718],{91182:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.definePersistedJob=function(){return new i([])},t.JobBuilder=void 0;var n=r(34301),s=r(5762);class i{constructor(e){this.steps=e}step(e,t){return this._stepWithOptions(e,"function"==typeof t?{code:t}:t)}_stepWithOptions(e,t){const{stopRetryIf:r,requirements:d,code:u}=t;let p=a(d,u,r);if(r){const{timePassedSeconds:e,appCrashed:t,onStopRetry:i}=r,d=a(null,function(e){return(t,r,s)=>Promise.resolve(e(t,r,s)).then((e=>e instanceof n.InterruptJob?e:new n.InterruptJob(e)))}(i),r);null!=e&&(p=o(((t,r,{jobStartTime:n})=>(0,s.happenedWithin)(n,e)),p,d)),t&&(p=o(((e,t,{afterCrash:r})=>!r),p,d))}return new i([...this.steps,{stepName:e,info:p}])}finalStep(e,t){const r=this.step(e,t);return{end:()=>r.steps}}}function o(e,t,r){return(n,s,i)=>e(n,s,i)?t(n,s,i):r(n,s,i)}function a(e,t,r){const n={requirements:e,code:t,stopRetryIf:r};return()=>n}t.JobBuilder=i},74227:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineWebPersistedJob=function(){return(0,n.definePersistedJob)()};var n=r(91182)},66718:(e,t,r)=>{"use strict";var n=r(95318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=n(r(48926)),i=r(22283),o=r(68132),a=r(12555),d=r(88410),u=r(74227),p=r(14090),l=r(37879),c=r(97926),_=r(37417);const f=new o.WapParser("rotateKeyResponseParser",(e=>{e.assertFromServer()}));var y=(0,u.defineWebPersistedJob)().step("uploadKeys",(0,s.default)((function*(){const e=yield c.waSignalStore.getRegistrationInfo().then((e=>{if(!e)throw new Error("No registration info is available");return c.waSignalStore.rotateSignedPreKey((0,d.toSignalCurveKeyPair)(e.identityKeyPair),l.generateSignedKeyPair)}));__LOG__(2)`rotateKey: signedPreKey uploading`;const t=(0,i.wap)("iq",{xmlns:"encrypt",type:"set",to:i.S_WHATSAPP_NET,id:(0,i.generateId)()},(0,i.wap)("rotate",null,(0,_.xmppSignedPreKey)(e))),r=yield(0,a.sendIq)(t,f);if(r.success)return{shouldDigestKey:!1};let n=!1;const s=r.errorCode;return 406===s?__LOG__(3)`rotateKey generated bad key`:409===s?(__LOG__(3)`skey does not pass server validation`,n=!0):s>=500?__LOG__(2)`rotateKey server error ${s}, wait a day`:(__LOG__(2)`rotateKey unrecognized error ${s}`,n=!0),{shouldDigestKey:n}}))).finalStep("maybeDigestKey",(e=>{const{shouldDigestKey:t}=e;if(t)return(0,p.digestKey)()})).end();t.default=y}}]);
//# sourceMappingURL=https://web.whatsapp.com/6718.59286883776e44c99808.js.map
