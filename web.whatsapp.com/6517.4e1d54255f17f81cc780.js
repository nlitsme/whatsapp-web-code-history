/*! Copyright (c) 2022 WhatsApp Inc. All Rights Reserved. */
(self.webpackChunkwhatsapp_web_client=self.webpackChunkwhatsapp_web_client||[]).push([[6517],{158114:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.JobBuilder=void 0,t.definePersistedJob=function(){return new i([])};var n=r(247901),s=r(892844);class i{constructor(e){this.steps=e}step(e,t){return this._stepWithOptions(e,"function"==typeof t?{code:t}:t)}_stepWithOptions(e,t){const{stopRetryIf:r,requirements:u,code:d}=t;let p=a(u,d,r);if(r){const{timePassedSeconds:e,appCrashed:t,onStopRetry:i}=r,u=a(null,function(e){return(t,r,s)=>Promise.resolve(e(t,r,s)).then((e=>e instanceof n.InterruptJob?e:new n.InterruptJob(e)))}(i),r);null!=e&&(p=o(((t,r,n)=>{let{jobStartTime:i}=n;return(0,s.happenedWithin)(i,e)}),p,u)),t&&(p=o(((e,t,r)=>{let{afterCrash:n}=r;return!n}),p,u))}return new i([...this.steps,{stepName:e,info:p}])}finalStep(e,t){const r=this.step(e,t);return{end:()=>r.steps}}}function o(e,t,r){return(n,s,i)=>e(n,s,i)?t(n,s,i):r(n,s,i)}function a(e,t,r){const n={requirements:e,code:t,stopRetryIf:r};return()=>n}t.JobBuilder=i},647292:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineWebPersistedJob=function(){return(0,n.definePersistedJob)()};var n=r(158114)},576517:(e,t,r)=>{"use strict";var n=r(595318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=n(r(348926)),i=r(736184),o=r(831914),a=r(471914),u=r(138062),d=r(647292),p=r(136727),l=r(985614),c=r(640623),_=r(21377);const f=new a.WapParser("rotateKeyResponseParser",(e=>{e.assertFromServer()}));var y=(0,d.defineWebPersistedJob)().step("uploadKeys",(0,s.default)((function*(){const e=yield c.waSignalStore.getRegistrationInfo().then((e=>{if(!e)throw new Error("No registration info is available");return c.waSignalStore.rotateSignedPreKey((0,u.toSignalCurveKeyPair)(e.identityKeyPair),l.generateSignedKeyPair)}));__LOG__(2)`rotateKey: signedPreKey uploading`;const t=(0,o.wap)("iq",{xmlns:"encrypt",type:"set",to:o.S_WHATSAPP_NET,id:(0,o.generateId)()},(0,o.wap)("rotate",null,(0,_.xmppSignedPreKey)(e))),r=yield(0,i.sendIq)(t,f);if(r.success)return{shouldDigestKey:!1};let n=!1;const s=r.errorCode;return 406===s?__LOG__(3)`rotateKey generated bad key`:409===s?(__LOG__(3)`skey does not pass server validation`,n=!0):s>=500?__LOG__(2)`rotateKey server error ${s}, wait a day`:(__LOG__(2)`rotateKey unrecognized error ${s}`,n=!0),{shouldDigestKey:n}}))).finalStep("maybeDigestKey",(e=>{const{shouldDigestKey:t}=e;if(t)return(0,p.digestKey)()})).end();t.default=y}}]);
//# sourceMappingURL=https://web.whatsapp.com/6517.4e1d54255f17f81cc780.js.map
